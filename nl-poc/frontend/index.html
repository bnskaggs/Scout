<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scout NL Analytics POC</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f6f6f6;
      }
      header {
        background: #1f2933;
        color: #fff;
        padding: 1rem 2rem;
      }
      main {
        padding: 2rem;
      }
      .input-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="text"] {
        flex: 1;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .context-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: #e2e8f0;
        color: #1f2937;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-size: 0.85rem;
        font-weight: 500;
      }
      .context-toggle span {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
        color: #475569;
      }
      .context-toggle button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.15rem 0.75rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .context-toggle button.off {
        background: #94a3b8;
      }
      .card {
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        margin-top: 1.5rem;
      }

      .result-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .result-meta {
        display: none;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .result-meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: #e0e7ff;
        color: #1f2933;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .error-panel {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid #fca5a5;
        background: #fee2e2;
        color: #7f1d1d;
      }
      .warning-panel {
        display: none;
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid #fbbf24;
        background: #fef3c7;
        color: #78350f;
      }
      .nql-status-banner {
        display: none;
        margin: 1rem 0;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        border: 1px solid #38bdf8;
        background: #e0f2fe;
        color: #0c4a6e;
        font-size: 0.9rem;
        font-weight: 500;
      }
      .warning-panel h3 {
        margin: 0 0 0.5rem;
        font-size: 1rem;
        font-weight: 600;
      }
      .error-panel h3 {
        margin: 0 0 0.5rem;
        font-size: 1rem;
        font-weight: 600;
      }
      .error-message {
        margin: 0 0 0.75rem;
      }
      .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .suggestion-pill {
        background: #fff;
        border: 1px solid #fca5a5;
        border-radius: 999px;
        color: #7f1d1d;
        padding: 0.35rem 0.85rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .suggestion-pill:hover {
        background: #fca5a5;
        color: #fff;
      }

      pre {
        background: #111827;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 4px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem;
        text-align: left;
      }
      .collapsible {
        margin-top: 1rem;
      }
      .chart-wrapper {
        width: 100%;
        box-sizing: border-box;
        height: 460px;
        max-width: 720px;
      }
      .chart-wrapper canvas {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        display: block;
      }

      /* Filter chips */
      .filter-chips {
        display: none;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
      }
      .filter-chip {
        display: inline-flex;
        align-items: center;
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
        border-radius: 999px;
        padding: 0.35rem 0.75rem;
        font-size: 0.9rem;
        font-weight: 500;
      }

      /* Action buttons */
      .action-buttons {
        display: none;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .action-buttons button {
        background: #10b981;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      .action-buttons button:hover {
        background: #059669;
      }

      .clarification-panel {
        display: none;
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .clarification-panel p {
        margin: 0 0 0.75rem;
        font-weight: 600;
      }

      .clarification-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .clarification-options button {
        background: #4f46e5;
        border: none;
        color: #fff;
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .clarification-options button:hover {
        background: #4338ca;
      }

      /* History sidebar */
      .history-panel {
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        margin-top: 1.5rem;
      }
      .history-panel h3 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .history-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 0.75rem;
      }
      .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .history-item-time {
        font-size: 0.8rem;
        color: #6b7280;
      }
      .history-item-query {
        font-size: 0.9rem;
        color: #374151;
        margin-bottom: 0.5rem;
      }
      .history-item button {
        background: #6366f1;
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
      }
      .history-item button:hover {
        background: #4f46e5;
      }
      .history-empty {
        color: #9ca3af;
        font-style: italic;
        text-align: center;
        padding: 1rem;
      }

      /* Summarizer styles */
      #explanation-container {
        margin: 20px 0;
        padding: 16px;
        background: #f8f9fa;
        border-left: 4px solid #4a90e2;
        border-radius: 4px;
        display: none;
      }
      .explanation-text {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
      }
      #followups-container {
        margin: 20px 0;
        display: none;
      }
      .followups-label {
        font-size: 14px;
        font-weight: 500;
        color: #666;
        margin-bottom: 10px;
      }
      .followups-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .followup-pill {
        padding: 8px 16px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .followup-pill:hover {
        background: #4a90e2;
        color: white;
        border-color: #4a90e2;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Scout NL Analytics</h1>
    </header>
    <main>
      <div class="card">
        <div class="input-row">
          <input id="question" type="text" placeholder="Ask about crime incidents..." />
          <button id="ask-btn">Ask</button>
          <div class="context-toggle" role="group" aria-label="Context memory">
            <span>Context</span>
            <button id="context-toggle" type="button">On</button>
          </div>
        </div>
        <div id="error-panel" class="error-panel">
          <h3>Error</h3>
          <p id="error-message" class="error-message"></p>
          <div id="suggestions" class="suggestions"></div>
        </div>
        <div id="clarification-panel" class="clarification-panel" aria-live="polite">
          <p id="clarification-question"></p>
          <div id="clarification-options" class="clarification-options"></div>
        </div>
      </div>
      <div class="card" id="result-card" style="display: none;">
        <div class="result-header">
          <h2 id="answer"></h2>
          <div class="result-meta" id="result-meta" aria-live="polite"></div>
        </div>

        <div id="nql-status" class="nql-status-banner" role="status" aria-live="polite"></div>

        <!-- Filter chips -->
        <div id="filter-chips" class="filter-chips"></div>

        <!-- Summarizer sections -->
        <div id="explanation-container">
          <div class="explanation-text"></div>
        </div>
        <div id="followups-container">
          <div class="followups-label">üí° You might also ask:</div>
          <div class="followups-pills"></div>
        </div>

        <!-- Action buttons -->
        <div id="action-buttons" class="action-buttons">
          <button id="copy-sql-btn">Copy SQL</button>
          <button id="copy-json-btn">Copy JSON Plan</button>
          <button id="download-csv-btn">Download CSV</button>
        </div>

        <div id="warning-panel" class="warning-panel">
          <h3>‚ö†Ô∏è Warning</h3>
          <ul id="warning-list" style="margin: 0; padding-left: 1.25rem;"></ul>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart"></canvas>
        </div>
        <div id="table-container"></div>
        <details class="collapsible">
          <summary>How I computed this</summary>
          <h3>SQL</h3>
          <pre id="sql"></pre>
          <h3>Plan</h3>
          <pre id="plan"></pre>
          <h3>Lineage</h3>
          <pre id="lineage"></pre>
        </details>
      </div>

      <!-- History panel -->
      <div class="history-panel">
        <h3>Recent Queries</h3>
        <div id="history-list" class="history-list">
          <div class="history-empty">No queries yet</div>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const askBtn = document.getElementById('ask-btn');
      const questionInput = document.getElementById('question');
      const errorPanel = document.getElementById('error-panel');
      const errorMessageEl = document.getElementById('error-message');
      const suggestionsContainer = document.getElementById('suggestions');
      const answerEl = document.getElementById('answer');
      const resultCard = document.getElementById('result-card');
      const sqlEl = document.getElementById('sql');
      const planEl = document.getElementById('plan');
      const lineageEl = document.getElementById('lineage');
      const tableContainer = document.getElementById('table-container');
      const chartCanvas = document.getElementById('chart');
      const warningPanel = document.getElementById('warning-panel');
      const warningList = document.getElementById('warning-list');
      const nqlStatusBanner = document.getElementById('nql-status');

      const resultMeta = document.getElementById('result-meta');
      const filterChipsContainer = document.getElementById('filter-chips');
      const actionButtonsContainer = document.getElementById('action-buttons');
      const historyListContainer = document.getElementById('history-list');
      const copySqlBtn = document.getElementById('copy-sql-btn');
      const copyJsonBtn = document.getElementById('copy-json-btn');
      const downloadCsvBtn = document.getElementById('download-csv-btn');
      const clarificationPanel = document.getElementById('clarification-panel');
      const clarificationQuestionEl = document.getElementById('clarification-question');
      const clarificationOptions = document.getElementById('clarification-options');
      const contextToggleBtn = document.getElementById('context-toggle');


      const SESSION_STORAGE_KEY = 'scout-session-id';

      function generateSessionId() {
        if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
          return crypto.randomUUID();
        }
        const random = Math.random().toString(16).slice(2);
        return `session-${Date.now()}-${random}`;
      }

      function getSessionId() {
        try {
          const stored = window.localStorage?.getItem(SESSION_STORAGE_KEY);
          if (stored) {
            return stored;
          }
        } catch (err) {
          // Ignore storage access issues and fall back to a fresh id
        }
        const fresh = generateSessionId();
        try {
          window.localStorage?.setItem(SESSION_STORAGE_KEY, fresh);
        } catch (err) {
          // Ignore storage write issues
        }
        return fresh;
      }


      let chartInstance;
      let lastFailedQuery = '';
      let currentData = null;  // Store current result data

      const sessionId = getSessionId();

      let pendingClarification = null;
      let isContextEnabled = true;

      const apiBase = window.location.port === '3000' ? 'http://127.0.0.1:8000' : window.location.origin;

      function renderContextToggle() {
        const label = isContextEnabled ? 'Turn context off' : 'Turn context on';
        contextToggleBtn.textContent = isContextEnabled ? 'On' : 'Off';
        contextToggleBtn.classList.toggle('off', !isContextEnabled);
        contextToggleBtn.setAttribute('aria-pressed', String(isContextEnabled));
        contextToggleBtn.setAttribute('aria-label', label);
        contextToggleBtn.title = label;
      }

      contextToggleBtn.addEventListener('click', () => {
        isContextEnabled = !isContextEnabled;
        renderContextToggle();
      });

      renderContextToggle();

      askBtn.addEventListener('click', () => submitQuestion(questionInput.value));
      questionInput.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          submitQuestion(questionInput.value);
        }
      });

      async function submitQuestion(rawQuestion) {
        const question = rawQuestion.trim();
        if (!question) {
          showErrorPanel('Please enter a question.');
          return;
        }

        hideErrorPanel();
        renderNqlStatus(null);
        const originalButtonText = askBtn.textContent;
        askBtn.disabled = true;
        askBtn.textContent = pendingClarification ? 'Clarifying...' : 'Thinking...';

        try {
          if (pendingClarification) {
            await sendClarificationAnswer(question);
          } else {
            await sendCompleteRequest(question);
          }
        } catch (err) {
          const message = err?.message || 'Something went wrong';
          const suggestions = Array.isArray(err?.suggestions) ? err.suggestions : [];
          if (!pendingClarification) {
            lastFailedQuery = question;
          }
          showErrorPanel(message, suggestions);
        } finally {
          askBtn.disabled = false;
          askBtn.textContent = originalButtonText;
        }
      }

      async function sendCompleteRequest(utterance) {
        const response = await fetch(`${apiBase}/chat/complete`, {
          method: 'POST',

          headers: {
            'Content-Type': 'application/json',
            'X-Session-Id': sessionId
          },

          body: JSON.stringify({ session_id: sessionId, utterance, context_enabled: isContextEnabled })
        });
        if (!response.ok) {
          throw await buildError(response);
        }
        const data = await response.json();
        if (data.status === 'clarification_needed') {
          pendingClarification = {
            question: data.question,
            missing: data.missing_slots || [],
            suggested: data.suggested_answers || [],
            originalUtterance: utterance,
          };
          showClarificationPrompt(data);
          return;
        }
        pendingClarification = null;
        renderResult(data, utterance);
      }

      async function sendClarificationAnswer(answer) {
        if (!pendingClarification) return;
        const response = await fetch(`${apiBase}/chat/clarify`, {
          method: 'POST',

          headers: {
            'Content-Type': 'application/json',
            'X-Session-Id': sessionId
          },

          body: JSON.stringify({ session_id: sessionId, answer })
        });
        if (!response.ok) {
          throw await buildError(response);
        }
        const data = await response.json();
        const original = pendingClarification?.originalUtterance;
        pendingClarification = null;
        const combined = original ? `${original} (${answer})` : answer;
        renderResult(data, combined);
      }

      async function buildError(response) {
        let errorDetail = {};
        try {
          errorDetail = await response.json();
        } catch (parseErr) {
          // ignore JSON parse errors and fallback to generic message
        }
        const detail = errorDetail?.detail ?? errorDetail;
        const message = typeof detail === 'string' ? detail : detail?.message || 'Request failed';
        const suggestions = Array.isArray(detail?.suggestions) ? detail.suggestions : [];
        const err = new Error(message);
        err.suggestions = suggestions;
        return err;
      }

      function showClarificationPrompt(data) {

        renderNqlStatus(null);

        clarificationQuestionEl.textContent = data.question || 'Can you clarify?';
        clarificationOptions.innerHTML = '';
        const answers = data.suggested_answers || [];
        answers.slice(0, 4).forEach(answer => {
          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = answer;
          button.addEventListener('click', () => submitQuestion(answer));
          clarificationOptions.appendChild(button);
        });
        clarificationPanel.style.display = 'block';
        questionInput.value = '';
        questionInput.focus();
      }

      function hideClarificationPrompt() {
        clarificationPanel.style.display = 'none';
        clarificationQuestionEl.textContent = '';
        clarificationOptions.innerHTML = '';
      }

      function hideErrorPanel() {
        errorPanel.style.display = 'none';
        errorMessageEl.textContent = '';
        suggestionsContainer.innerHTML = '';
      }

      function showErrorPanel(message, suggestions = []) {
        errorMessageEl.textContent = message;
        suggestionsContainer.innerHTML = '';

        if (suggestions.length) {
          // Extract the incorrect value from the error message
          // Message format: "Could not find value 'Hoolywood' for area"
          const incorrectValueMatch = message.match(/value ['"]([^'"]+)['"]/i);
          const incorrectValue = incorrectValueMatch ? incorrectValueMatch[1] : null;

          suggestions.forEach(suggestion => {
            const button = document.createElement('button');
            button.className = 'suggestion-pill';
            button.type = 'button';
            button.textContent = suggestion;
            button.addEventListener('click', () => {
              let newQuery;
              if (incorrectValue && lastFailedQuery) {
                // Replace only the incorrect value in the original query
                // Use word boundaries and case-insensitive match
                const regex = new RegExp(`\\b${incorrectValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                newQuery = lastFailedQuery.replace(regex, suggestion);
              } else {
                // Fallback: use suggestion as-is
                newQuery = suggestion;
              }
              questionInput.value = newQuery;
              submitQuestion(newQuery);
            });
            suggestionsContainer.appendChild(button);
          });
          suggestionsContainer.style.display = 'flex';
        } else {
          suggestionsContainer.style.display = 'none';
        }

        errorPanel.style.display = 'block';
      }

      function renderResult(data, utterance) {
        hideClarificationPrompt();
        hideSummary();  // Clear previous summary
        currentData = data;  // Store current data
        currentData.question = utterance;

        resultCard.style.display = 'block';
        answerEl.textContent = data.answer;
        renderMetadata(data);
        renderNqlStatus(data.nql_status || null);
        renderWarnings(data.warnings || []);
        sqlEl.textContent = data.sql;
        planEl.textContent = JSON.stringify(data.plan, null, 2);
        lineageEl.textContent = JSON.stringify(data.lineage, null, 2);
        renderTable(data.table);
        renderChart(data.chart);
        renderPlanChips(data.chips);
        actionButtonsContainer.style.display = 'flex';

        // Add to history
        addToHistory(utterance);
        questionInput.value = '';

        // Fetch and display summary if available
        if (data.has_summarizer) {
          fetchAndDisplaySummary(data);
        }
      }

      function renderNqlStatus(status) {
        if (!status || status.valid) {
          nqlStatusBanner.style.display = 'none';
          nqlStatusBanner.textContent = '';
          nqlStatusBanner.removeAttribute('title');
          return;
        }

        let message;
        if (status.attempted === false) {
          const reason = status.reason || 'nql_not_attempted';
          message = `NQL not used (${reason})`;
        } else {
          const stage = status.stage ? status.stage.toUpperCase() : 'UNKNOWN';
          const reason = status.reason || 'error';
          const fallback = status.fallback ? status.fallback.toUpperCase() : 'LEGACY';
          message = `NQL fallback (${stage}): ${reason} ‚Üí ${fallback}`;
        }

        nqlStatusBanner.textContent = message;
        if (status.detail) {
          nqlStatusBanner.title = status.detail;
        } else {
          nqlStatusBanner.removeAttribute('title');
        }
        nqlStatusBanner.style.display = 'block';

      }

      function renderWarnings(warnings) {
        if (!warnings || warnings.length === 0) {
          warningPanel.style.display = 'none';
          warningList.innerHTML = '';
          return;
        }
        warningList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
        warningPanel.style.display = 'block';
      }

      function renderMetadata(data) {
        const badges = [];
        if (data.engine) {
          const engine = typeof data.engine === 'string' ? data.engine.toLowerCase() : '';
          const engineLabel = engine === 'nql' ? 'NQL' : engine === 'legacy' ? 'Legacy' : data.engine;
          badges.push(`<span><strong>Engine:</strong> ${engineLabel}</span>`);
        }
        const runtime = formatRuntime(data.runtime_ms);
        if (runtime) {
          badges.push(`<span><strong>Runtime:</strong> ${runtime}</span>`);
        }
        const rowcount = formatCount(data.rowcount);
        if (rowcount) {
          badges.push(`<span><strong>Rows:</strong> ${rowcount}</span>`);
        }
        resultMeta.innerHTML = badges.join('');
        resultMeta.style.display = badges.length ? 'flex' : 'none';
      }

      function formatRuntime(value) {
        const runtime = Number(value);
        if (!Number.isFinite(runtime)) {
          return null;
        }
        if (runtime >= 1000) {
          const seconds = runtime / 1000;
          const precision = seconds >= 10 ? 1 : 2;
          return `${seconds.toFixed(precision)} s`;
        }
        const precision = runtime >= 100 ? 0 : runtime >= 10 ? 1 : 2;
        return `${runtime.toFixed(precision)} ms`;
      }

      function formatCount(value) {
        const count = Number(value);
        if (!Number.isFinite(count)) {
          return value ? String(value) : null;
        }
        return new Intl.NumberFormat('en-US').format(count);
      }

      function renderTable(rows) {
        if (!rows || !rows.length) {
          tableContainer.innerHTML = '<p>No rows returned.</p>';
          return;
        }
        let headers = Object.keys(rows[0]);

        // If formatted column exists, hide the raw column
        if (headers.includes('change_pct_formatted')) {
          headers = headers.filter(h => h !== 'change_pct');
        }

        const headerHtml = headers.map(h => `<th>${h}</th>`).join('');
        const bodyHtml = rows.map(row => {
          const cells = headers.map(h => `<td>${row[h] ?? ''}</td>`).join('');
          return `<tr>${cells}</tr>`;
        }).join('');
        tableContainer.innerHTML = `<table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
      }

      function renderChart(chart) {
        if (!chart || !chart.data || !chart.data.length) {
          if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
          const context = chartCanvas.getContext('2d');
          if (context) {
            context.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
          }
          return;
        }

        const dateFormatter = chart.x === 'month'
          ? new Intl.DateTimeFormat(undefined, { month: 'short', year: 'numeric' })
          : null;

        const labels = chart.data.map(row => {
          const rawLabel = row[chart.x];
          if (dateFormatter) {
            const date = new Date(rawLabel);
            if (!Number.isNaN(date.valueOf())) {
              return dateFormatter.format(date);
            }
          }
          return rawLabel != null ? String(rawLabel) : '';
        });

        const dataValues = chart.data.map(row => Number(row[chart.y]) || 0);

        const datasetConfig = chart.type === 'line'
          ? {
              label: chart.y,
              data: dataValues,
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.2)',
              borderWidth: 2,
              pointRadius: 4,
              tension: 0.3,
              fill: false
            }
          : {
              label: chart.y,
              data: dataValues,
              backgroundColor: 'rgba(37, 99, 235, 0.6)',
              borderColor: 'rgba(37, 99, 235, 1)',
              borderWidth: 1,
              borderSkipped: false
            };

        const chartConfig = {
          type: chart.type || 'bar',
          data: {
            labels,
            datasets: [datasetConfig]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: { enabled: true },
              legend: { display: true }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        };

        if (chartInstance) {
          if (chartInstance.config.type !== chartConfig.type) {
            chartInstance.destroy();
            chartInstance = new Chart(chartCanvas, chartConfig);
          } else {
            chartInstance.data.labels = labels;
            chartInstance.data.datasets = [datasetConfig];
            chartInstance.options = chartConfig.options;
            chartInstance.update();
          }
        } else {
          chartInstance = new Chart(chartCanvas, chartConfig);
        }
      }

      // ============ Plan Chips ============
      function renderPlanChips(chips) {
        const groups = [
          { label: 'Time', values: (chips && chips.time) || [] },
          { label: 'Dimensions', values: (chips && chips.dimensions) || [] },
          { label: 'Filters', values: (chips && chips.filters) || [] },
        ];

        const items = [];
        groups.forEach(group => {
          group.values.forEach(value => {
            items.push({ label: group.label, value });
          });
        });

        if (!items.length) {
          filterChipsContainer.style.display = 'none';
          filterChipsContainer.innerHTML = '';
          return;
        }

        filterChipsContainer.innerHTML = '';
        filterChipsContainer.style.display = 'flex';

        items.forEach(item => {
          const chip = document.createElement('div');
          chip.className = 'filter-chip';
          chip.textContent = `${item.label}: ${item.value}`;
          filterChipsContainer.appendChild(chip);
        });
      }

      // ============ Copy/Download Buttons ============
      copySqlBtn.addEventListener('click', event => {
        if (!currentData || !currentData.sql) return;
        copyToClipboard(currentData.sql, event.currentTarget);
      });

      copyJsonBtn.addEventListener('click', event => {
        if (!currentData || !currentData.plan) return;
        const jsonStr = JSON.stringify(currentData.plan, null, 2);
        copyToClipboard(jsonStr, event.currentTarget);
      });

      downloadCsvBtn.addEventListener('click', () => {
        if (!currentData || !currentData.table) return;
        downloadAsCSV(currentData.table, 'scout-results.csv');
      });

      function copyToClipboard(text, button) {
        navigator.clipboard.writeText(text).then(() => {
          if (button) {
            const originalText = button.textContent;
            button.textContent = '‚úì Copied!';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy to clipboard');
        });
      }

      function downloadAsCSV(rows, filename) {
        if (!rows || rows.length === 0) return;

        const headers = Object.keys(rows[0]);
        const csvRows = [];

        // Add header row
        csvRows.push(headers.join(','));

        // Add data rows
        rows.forEach(row => {
          const values = headers.map(header => {
            const value = row[header];
            // Escape commas and quotes
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
          });
          csvRows.push(values.join(','));
        });

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // ============ Summarizer Functions ============
      async function fetchAndDisplaySummary(queryData) {
        try {
          const response = await fetch(`${apiBase}/chat/summarize`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Session-Id': sessionId
            },
            body: JSON.stringify({
              results: queryData.table,
              plan: queryData.plan
            })
          });

          if (!response.ok) {
            console.warn('Summarizer failed, skipping');
            hideSummary();
            return;
          }

          const summary = await response.json();
          displaySummary(summary);
        } catch (error) {
          console.error('Summary fetch error:', error);
          hideSummary();
        }
      }

      function displaySummary(summary) {
        // Show and populate explanation
        const explanationContainer = document.getElementById('explanation-container');
        const explanationText = explanationContainer.querySelector('.explanation-text');
        explanationText.textContent = summary.explanation;
        explanationContainer.style.display = 'block';

        // Show and populate follow-ups
        const followupsContainer = document.getElementById('followups-container');
        const followupsPills = followupsContainer.querySelector('.followups-pills');

        followupsPills.innerHTML = summary.followups.map(query =>
          `<button class="followup-pill" data-query="${escapeHtml(query)}">${escapeHtml(query)}</button>`
        ).join('');

        followupsContainer.style.display = 'block';

        // Attach click handlers
        followupsPills.querySelectorAll('.followup-pill').forEach(pill => {
          pill.addEventListener('click', () => {
            const query = pill.getAttribute('data-query');
            questionInput.value = query;
            submitQuestion(query);
          });
        });
      }

      function hideSummary() {
        document.getElementById('explanation-container').style.display = 'none';
        document.getElementById('followups-container').style.display = 'none';
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ============ History Management ============
      const HISTORY_KEY = 'scout-query-history';
      const MAX_HISTORY = 10;

      function getHistory() {
        try {
          const stored = localStorage.getItem(HISTORY_KEY);
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          console.error('Failed to load history:', e);
          return [];
        }
      }

      function saveHistory(history) {
        try {
          localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        } catch (e) {
          console.error('Failed to save history:', e);
        }
      }

      function addToHistory(query) {
        if (!query || !query.trim()) return;

        const history = getHistory();
        const entry = {
          query: query.trim(),
          timestamp: new Date().toISOString(),
        };

        // Remove duplicate if exists
        const filtered = history.filter(h => h.query !== entry.query);

        // Add to front and limit to MAX_HISTORY
        filtered.unshift(entry);
        const limited = filtered.slice(0, MAX_HISTORY);

        saveHistory(limited);
        renderHistory();
      }

      function renderHistory() {
        const history = getHistory();

        if (history.length === 0) {
          historyListContainer.innerHTML = '<div class="history-empty">No queries yet</div>';
          return;
        }

        historyListContainer.innerHTML = '';

        history.forEach((entry, index) => {
          const item = document.createElement('div');
          item.className = 'history-item';

          const header = document.createElement('div');
          header.className = 'history-item-header';

          const time = document.createElement('div');
          time.className = 'history-item-time';
          time.textContent = formatTimestamp(entry.timestamp);

          header.appendChild(time);

          const queryDiv = document.createElement('div');
          queryDiv.className = 'history-item-query';
          queryDiv.textContent = entry.query;

          const rerunBtn = document.createElement('button');
          rerunBtn.textContent = 'Re-run';
          rerunBtn.addEventListener('click', () => {
            questionInput.value = entry.query;
            submitQuestion(entry.query);
          });

          item.appendChild(header);
          item.appendChild(queryDiv);
          item.appendChild(rerunBtn);
          historyListContainer.appendChild(item);
        });
      }

      function formatTimestamp(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Initialize history on page load
      renderHistory();
    </script>
  </body>
</html>
